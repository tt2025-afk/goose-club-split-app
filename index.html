<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éµéµä¿±æ¨‚éƒ¨-åˆ†å¸³ç¶²é </title>
    <style>
        /* [CSS æ¨£å¼...] */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f4f7f6; }
        h1, h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 25px; }
        .container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        input[type="text"], input[type="number"], select { padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; width: calc(100% - 22px); box-sizing: border-box; }
        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; transition: background-color 0.3s; margin-right: 5px; }
        button:hover { background-color: #0056b3; }
        .member-action-btn, .expense-action-btn { padding: 5px 10px; margin-left: 10px; font-size: 0.8em; }
        .edit-btn { background-color: #ffc107; color: #333; }
        .edit-btn:hover { background-color: #e0a800; }
        .delete-btn { background-color: #dc3545; }
        .delete-btn:hover { background-color: #bd2130; }
        #cancelEditBtn { background-color: #6c757d; }
        #cancelEditBtn:hover { background-color: #5a6268; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #e9ecef; }
        .net-positive { color: green; font-weight: bold; }
        .net-negative { color: red; font-weight: bold; }
        .split-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .split-checkbox-group label { background-color: #eaf4ff; padding: 5px 10px; border-radius: 15px; cursor: pointer; }
        .member-item { margin: 5px 0; padding: 5px 0; border-bottom: 1px dotted #ccc; display: flex; justify-content: space-between; align-items: center; }
        #selectAllLabel { background-color: #28a745 !important; color: white; font-weight: bold; }
        label[for="paidBy"] { display: block; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¦¢ éµéµä¿±æ¨‚éƒ¨-åˆ†å¸³ç¶²é </h1>

    <section>
        <h2>1. æˆå“¡è¨­å®š</h2>
        <input type="text" id="memberInput" placeholder="è¼¸å…¥æˆå“¡åç¨±">
        <button id="addMemberBtn">æ–°å¢æˆå“¡</button>
        <h3>ç•¶å‰æˆå“¡åˆ—è¡¨:</h3>
        <div id="memberList"></div>
        <p style="color: red; font-size: 0.9em; margin-top: 10px;">*åˆªé™¤æˆ–ç·¨è¼¯æˆå“¡åç¨±å°‡æ¸…ç©ºæ‰€æœ‰æ”¯å‡ºç´€éŒ„ï¼Œè«‹è¬¹æ…æ“ä½œã€‚</p>
    </section>

    <hr>

    <section>
        <h2>2. è¨˜éŒ„æ”¯å‡º</h2>
        <input type="text" id="expenseName" placeholder="æ”¯å‡ºèªªæ˜ (ä¾‹å¦‚: æ™šé¤)">
        <input type="number" id="expenseAmount" placeholder="é‡‘é¡ (è‡ªå‹•å–æ•´æ•¸)" min="0" step="1">
        <label for="paidBy">ä»˜æ¬¾äºº:</label>
        <select id="paidBy"></select>
        <h3>åˆ†æ”¤æˆå“¡:</h3>
        <div id="splitMembersContainer" class="split-checkbox-group">
            <p id="noMembersMsg" style="color: orange;">è«‹å…ˆæ–°å¢æˆå“¡æ‰èƒ½è¨˜éŒ„æ”¯å‡ºï¼</p>
        </div>
        <button id="addExpenseBtn">è¨˜éŒ„æ”¯å‡º</button>
        <button id="cancelEditBtn" style="display:none;">å–æ¶ˆç·¨è¼¯</button>

        <h3>æ”¯å‡ºæ­·å²:</h3>
        <table id="expenseTable">
            <thead>
                <tr>
                    <th>èªªæ˜</th>
                    <th>é‡‘é¡</th>
                    <th>ä»˜æ¬¾äºº</th>
                    <th>åˆ†æ”¤äºº</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="expenseTbody"> 
            </tbody>
        </table>
    </section>

    <hr>

    <section>
        <h2>3. çµç®—çµæœèˆ‡å»ºè­°</h2>
        <h3>æˆå“¡æ·¨é¡:</h3>
        <table id="netTable">
            <thead>
                <tr>
                    <th>æˆå“¡</th>
                    <th>æ·¨é¡</th>
                    <th>ç‹€æ…‹</th>
                </tr>
            </thead>
            <tbody id="netTbody">
            </tbody>
        </table>
        <h3>è½‰å¸³å»ºè­° (æœ€å°‘æ¬¡æ•¸):</h3>
        <div id="settlementSuggestions">
        </div>
    </section>
</div>

<script>
    // æ ¸å¿ƒæ•¸æ“šçµæ§‹ (ä½¿ç”¨é è¨­æˆå“¡)
    let members = ["è˜‹æœ", "å¤§å“¥", "å°æ¯›", "ç¿”å“¥", "çƒé¾œ", "è€€å“¥", "èŠ‹åœ“", "å¯§å¯§", "ç¬¨è›‹"]; 
    let expenses = []; 
    let currentlyEditingIndex = null; 

    // --- 1. æ ¸å¿ƒï¼šåˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š ---
    document.addEventListener('DOMContentLoaded', () => {
        // ç¶å®šéœæ…‹æŒ‰éˆ•
        document.getElementById('addMemberBtn').addEventListener('click', addMember);
        document.getElementById('addExpenseBtn').addEventListener('click', addExpense);
        document.getElementById('cancelEditBtn').addEventListener('click', resetExpenseForm);

        // ç¶å®šå‹•æ…‹åˆ—è¡¨ (ä½¿ç”¨äº‹ä»¶å§”æ´¾)
        document.getElementById('memberList').addEventListener('click', handleMemberActions);
        document.getElementById('expenseTbody').addEventListener('click', handleExpenseActions);
        document.getElementById('splitMembersContainer').addEventListener('change', handleSplitMemberChange);

        // é é¢é¦–æ¬¡è¼‰å…¥
        updateUI();
        calculateAndDisplaySettlement();
    });

    /**
     * @description æ›´æ–°æ‰€æœ‰ä»‹é¢
     */
    function updateUI() {
        displayMemberList();
        populatePaidBySelect();
        populateSplitMembersCheckboxes(); 
        displayExpenses();
    }
    
    // --- 2. æˆå“¡ç®¡ç† ---
    function addMember() {
        const input = document.getElementById('memberInput');
        const name = input.value.trim();
        if (name && !members.includes(name)) {
            members.push(name); 
            input.value = '';
            updateUI(); 
            calculateAndDisplaySettlement();
        } else if (name) {
            alert('æˆå“¡åç¨±å·²å­˜åœ¨æˆ–ç‚ºç©ºï¼');
        }
    }

    function displayMemberList() {
        const listDiv = document.getElementById('memberList');
        listDiv.innerHTML = members.map((m, index) => `
            <div class="member-item">
                <span>${m}</span>
                <div>
                    <button class="member-action-btn edit-btn" data-action="edit" data-index="${index}" data-name="${m}">ç·¨è¼¯</button>
                    <button class="member-action-btn delete-btn" data-action="delete" data-index="${index}" data-name="${m}">åˆªé™¤</button>
                </div>
            </div>
        `).join('');
    }

    function handleMemberActions(event) {
        const action = event.target.dataset.action;
        const index = parseInt(event.target.dataset.index, 10);
        const name = event.target.dataset.name;

        if (action === 'edit') {
            editMember(index, name);
        } else if (action === 'delete') {
            deleteMember(index, name);
        }
    }

    function editMember(index, oldName) {
        const newName = prompt(`è«‹è¼¸å…¥ ${oldName} çš„æ–°åç¨±:`, oldName);
        if (newName && newName.trim() !== oldName && !members.includes(newName.trim())) {
            const confirmReset = confirm(`è­¦å‘Šï¼šç·¨è¼¯æˆå“¡åç¨± (${oldName} -> ${newName}) æœƒæ¸…é™¤æ‰€æœ‰ç¾æœ‰çš„æ”¯å‡ºç´€éŒ„ä»¥ç¢ºä¿çµç®—æ­£ç¢ºã€‚æ˜¯å¦ç¹¼çºŒï¼Ÿ`);
            if (!confirmReset) return;
            members[index] = newName.trim();
            expenses = []; 
            updateUI();
            calculateAndDisplaySettlement();
        } else if (newName) {
            alert('åç¨±ç„¡è®Šæ›´ã€å·²è¢«ä½¿ç”¨æˆ–ç‚ºç©ºï¼');
        }
    }

    function deleteMember(index, nameToDelete) {
        const confirmDelete = confirm(`è­¦å‘Šï¼šåˆªé™¤æˆå“¡ ${nameToDelete} æœƒæ¸…é™¤æ‰€æœ‰ç¾æœ‰çš„æ”¯å‡ºç´€éŒ„ä»¥ç¢ºä¿çµç®—æ­£ç¢ºã€‚æ˜¯å¦ç¹¼çºŒï¼Ÿ`);
        if (confirmDelete) {
            members.splice(index, 1);
            expenses = []; 
            updateUI();
            calculateAndDisplaySettlement();
        }
    }

    // --- 3. æ”¯å‡ºè¨˜éŒ„ (åŒ…å«ç·¨è¼¯/åˆªé™¤) ---

    function populatePaidBySelect() {
        const select = document.getElementById('paidBy');
        select.innerHTML = members.map(m => `<option value="${m}">${m}</option>`).join('');
    }

    function toggleAllSplitMembers(checked) {
        document.querySelectorAll('input[name="splitMember"]').forEach(cb => {
            if (cb.id !== 'selectAll') {
                cb.checked = checked;
            }
        });
        updateSelectAllCheckbox();
    }

    function populateSplitMembersCheckboxes() {
        const container = document.getElementById('splitMembersContainer');
        const noMembersMsg = document.getElementById('noMembersMsg');
        if (members.length === 0) {
            container.innerHTML = '';
            noMembersMsg.style.display = 'block';
            return;
        }
        noMembersMsg.style.display = 'none';
        let checkboxesHtml = `
            <label id="selectAllLabel">
                <input type="checkbox" id="selectAll" data-action="toggleAll" checked> 
                âœ“ å‹¾é¸å…¨éƒ¨ / å–æ¶ˆå…¨éƒ¨
            </label>
        `;
        checkboxesHtml += members.map(m => `
            <label>
                <input type="checkbox" name="splitMember" value="${m}" data-action="checkMember" checked> 
                ${m}
            </label>
        `).join('');
        container.innerHTML = checkboxesHtml;
    }

    function handleSplitMemberChange(event) {
        const action = event.target.dataset.action;
        if (action === 'toggleAll') {
            toggleAllSplitMembers(event.target.checked);
        } else if (action === 'checkMember') {
            updateSelectAllCheckbox();
        }
    }

    function updateSelectAllCheckbox() {
        const allMemberCheckboxes = document.querySelectorAll('input[name="splitMember"]');
        const checkedCount = Array.from(allMemberCheckboxes).filter(cb => cb.checked).length;
        document.getElementById('selectAll').checked = checkedCount === allMemberCheckboxes.length;
    }

    function addExpense() {
        if (members.length === 0) {
            alert('è«‹å…ˆæ–°å¢æˆå“¡æ‰èƒ½è¨˜éŒ„æ”¯å‡ºï¼');
            return;
        }
        const name = document.getElementById('expenseName').value.trim();
        
        // *** ä¿®æ­£ 2: é‡‘é¡æ”¹ç‚º "ç„¡æ¢ä»¶æ¨å»" (Math.floor) ***
        const amount = Math.floor(parseFloat(document.getElementById('expenseAmount').value));
        
        const paidBy = document.getElementById('paidBy').value;
        const splitCheckboxes = Array.from(document.querySelectorAll('input[name="splitMember"]:checked'))
                                     .filter(cb => cb.id !== 'selectAll');
        const splitAmong = splitCheckboxes.map(cb => cb.value);

        if (!name || isNaN(amount) || amount <= 0 || !paidBy || splitAmong.length === 0) {
            alert('è«‹ç¢ºèªæ‰€æœ‰æ”¯å‡ºæ¬„ä½éƒ½å·²æ­£ç¢ºå¡«å¯« (é‡‘é¡éœ€ > 0)ï¼Œä¸”åˆ†æ”¤æˆå“¡è‡³å°‘æœ‰ä¸€ä½ï¼');
            return;
        }
        
        const newExpense = { name, amount: amount, paidBy, splitAmong };

        if (currentlyEditingIndex !== null) {
            expenses[currentlyEditingIndex] = newExpense;
        } else {
            expenses.push(newExpense);
        }

        resetExpenseForm(); 
        displayExpenses();
        calculateAndDisplaySettlement();
    }

    function handleExpenseActions(event) {
        const action = event.target.dataset.action;
        const index = parseInt(event.target.dataset.index, 10);

        if (action === 'edit') {
            editExpense(index);
        } else if (action === 'delete') {
            deleteExpense(index);
        }
    }

    function deleteExpense(index) {
        const expenseName = expenses[index].name;
        if (confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ\n"${expenseName}"`)) {
            expenses.splice(index, 1); 
            displayExpenses();
            calculateAndDisplaySettlement();
        }
    }

    function editExpense(index) {
        currentlyEditingIndex = index;
        const exp = expenses[index];

        document.getElementById('expenseName').value = exp.name;
        document.getElementById('expenseAmount').value = exp.amount;
        document.getElementById('paidBy').value = exp.paidBy;

        document.querySelectorAll('input[name="splitMember"]').forEach(cb => {
            cb.checked = exp.splitAmong.includes(cb.value);
        });
        updateSelectAllCheckbox(); 

        document.getElementById('addExpenseBtn').innerText = 'å„²å­˜è®Šæ›´';
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
        
        window.scrollTo(0, 0);
        document.getElementById('expenseName').focus();
    }
    
    function resetExpenseForm() {
        currentlyEditingIndex = null; 
        document.getElementById('expenseName').value = '';
        document.getElementById('expenseAmount').value = '';
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        
        document.getElementById('addExpenseBtn').innerText = 'è¨˜éŒ„æ”¯å‡º';
        document.getElementById('cancelEditBtn').style.display = 'none';
    }


    function displayExpenses() {
        const tbody = document.getElementById('expenseTbody');
        
        if (expenses.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888;">ç›®å‰æ²’æœ‰æ”¯å‡ºç´€éŒ„ã€‚</td></tr>';
        } else {
            tbody.innerHTML = expenses.map((exp, index) => `
                <tr>
                    <td>${exp.name}</td>
                    <td>$${exp.amount}</td> 
                    <td>${exp.paidBy}</td>
                    <td>${exp.splitAmong.join(', ')}</td>
                    <td>
                        <button class="expense-action-btn edit-btn" data-action="edit" data-index="${index}">ç·¨è¼¯</button>
                        <button class="expense-action-btn delete-btn" data-action="delete" data-index="${index}">åˆªé™¤</button>
                    </td>
                </tr>
            `).join('');
        }
    }

    // --- 4. çµç®—è¨ˆç®—é‚è¼¯ (æ ¸å¿ƒ) ---
    /**
     * @description æ ¸å¿ƒè¨ˆç®— (ä½¿ç”¨æ•´æ•¸é¤˜æ•¸åˆ†é…æ³•)
     */
    function calculateAndDisplaySettlement() {
        const netTbody = document.getElementById('netTbody');
        const suggestionsDiv = document.getElementById('settlementSuggestions');

        if (members.length === 0) {
            netTbody.innerHTML = '<tr><td colspan="3">è«‹å…ˆæ–°å¢æˆå“¡ã€‚</td></tr>';
            suggestionsDiv.innerHTML = '<p>è«‹å…ˆæ–°å¢æˆå“¡ä¸¦è¨˜éŒ„æ”¯å‡ºã€‚</p>';
            return;
        }
        const netAmounts = {};
        members.forEach(m => netAmounts[m] = 0);
        
        expenses.forEach(exp => {
            const splitCount = exp.splitAmong.length;
            if (splitCount === 0) return;

            // *** ä¿®æ­£ 4: é€™æ˜¯æœ€å…¬å¹³çš„æ•´æ•¸åˆ†å¸³æ³• ***
            netAmounts[exp.paidBy] += exp.amount; // 1. ä»˜æ¬¾äººç²å¾—å…¨é¡
            
            const baseShare = Math.floor(exp.amount / splitCount); // 2. è¨ˆç®—åŸºæœ¬åˆ†æ”¤
            const remainder = exp.amount % splitCount; // 3. è¨ˆç®—é¤˜æ•¸

            // 4. åˆ†é…æ”¯å‡º
            exp.splitAmong.forEach((member, index) => {
                let shareForThisPerson = baseShare;
                if (index < remainder) {
                    shareForThisPerson += 1; // å‰ 'remainder' å€‹äººå¤šä»˜ $1
                }
                netAmounts[member] -= shareForThisPerson; // æ‰£é™¤åˆ†æ”¤
            });
        });

        displayNetAmounts(netAmounts); 
        calculateSettlements(netAmounts);
    }

    function displayNetAmounts(netAmounts) {
        const tbody = document.getElementById('netTbody');
        tbody.innerHTML = '';
        members.forEach(member => {
            // ä¿®æ­£ 5: æ·¨é¡å·²ç¶“æ˜¯æ•´æ•¸ï¼Œç›´æ¥ä½¿ç”¨
            const net = netAmounts[member] || 0; 
            const statusClass = net > 0 ? 'net-positive' : (net < 0 ? 'net-negative' : '');
            const statusText = net > 0 ? 'æ‡‰æ”¶' : (net < 0 ? 'æ‡‰ä»˜' : 'çµæ¸…');
            const row = `
                <tr>
                    <td>${member}</td>
                    <td class="${statusClass}">$${Math.abs(net)}</td> 
                    <td>${statusText}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function calculateSettlements(netAmounts) {
        const suggestionsDiv = document.getElementById('settlementSuggestions');
        
        // ä¿®æ­£ 6: æ·¨é¡å·²ç¶“æ˜¯æ•´æ•¸ï¼Œç›´æ¥éæ¿¾
        const balances = Object.entries(netAmounts)
            .filter(([, net]) => net !== 0) // åªä¿ç•™éé›¶æ·¨é¡
            .sort((a, b) => a[1] - b[1]); 

        let i = 0; 
        let j = balances.length - 1; 
        const settlements = [];
        
        // ä¿®æ­£ 7: ç§»é™¤å°æ•¸é»æ¯”è¼ƒé‚è¼¯ï¼Œæ”¹ç”¨ç²¾ç¢ºçš„æ•´æ•¸
        while (i < j) {
            const debtor = balances[i][0];
            let debtorNet = balances[i][1]; 
            const creditor = balances[j][0];
            let creditorNet = balances[j][1]; 

            const amountToTransfer = Math.min(creditorNet, -debtorNet);

            if (amountToTransfer > 0) {
                settlements.push({ from: debtor, to: creditor, amount: amountToTransfer });
            }
            balances[i][1] += amountToTransfer; 
            balances[j][1] -= amountToTransfer; 
            
            if (balances[i][1] === 0) { i++; }
            if (balances[j][1] === 0) { j--; }
        }
        
        if (settlements.length === 0 && members.length > 0) {
            suggestionsDiv.innerHTML = '<p>ğŸ‰ æ‰€æœ‰æˆå“¡çš†å·²çµæ¸…ï¼</p>';
        } else if (settlements.length === 0) {
             suggestionsDiv.innerHTML = '<p>è«‹å…ˆæ–°å¢æˆå“¡ã€‚</p>';
        } else {
            suggestionsDiv.innerHTML = settlements.map(s => 
                // ä¿®æ­£ 8: é¡¯ç¤ºæ•´æ•¸
                `<p>ğŸ‘‰ <strong>${s.from}</strong> æ‡‰è©²è½‰å¸³çµ¦ <strong>${s.to}</strong>ï¼š<span style="font-weight:bold; color:#d9534f;"> $${s.amount}</span></p>`
            ).join('');
        }
    }
</script>

</body>
</html>
