<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éµéµä¿±æ¨‚éƒ¨-åˆ†å¸³ç¶²é </title>
    <style>
        :root {
            --primary-color: #4a90e2; /* æŸ”å’Œè— */
            --accent-color: #50c878;  /* ç¿¡ç¿ ç¶  */
            --danger-color: #ff6b6b;  /* æŸ”å’Œç´… */
            --bg-color: #f4f7f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-radius: 12px;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        h2 {
            font-size: 1.2rem;
            color: #555;
            border-left: 5px solid var(--primary-color);
            padding-left: 10px;
            margin-top: 0;
        }

        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            transition: transform 0.2s;
        }

        .card:hover { transform: translateY(-2px); }

        input[type="text"], input[type="number"], select {
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border 0.3s;
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 10px;
            font-size: 0.95rem;
            width: 100%;
        }

        #addMemberBtn, #addExpenseBtn {
            background-color: var(--primary-color);
            color: white;
        }
        
        #addMemberBtn:hover, #addExpenseBtn:hover {
            background-color: #357abd;
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);
        }

        #cancelEditBtn {
            background-color: #95a5a6;
            color: white;
        }

        /* è¤‡è£½æŒ‰éˆ• */
        #copyToLineBtn {
            background-color: #06c755; /* LINE ç¶  */
            color: white;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        #copyToLineBtn:hover {
            background-color: #05b34c;
            box-shadow: 0 4px 12px rgba(6, 199, 85, 0.3);
        }

        /* å°æ“ä½œæŒ‰éˆ• */
        .action-btn {
            padding: 5px 12px;
            margin-left: 5px;
            font-size: 0.85rem;
            border-radius: 6px;
            width: auto; /* è¦†è“‹å…¨å¯¬è¨­å®š */
        }

        .btn-edit { background-color: #f1c40f; color: #fff; }
        .btn-edit:hover { background-color: #d4ac0d; }

        .btn-del { background-color: var(--danger-color); color: white; }
        .btn-del:hover { background-color: #e55050; }

        /* è¡¨æ ¼æ¨£å¼ */
        table {
            width: 100%;
            border-collapse: separate; 
            border-spacing: 0;
            margin-top: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th { background-color: #f8f9fa; font-weight: 600; color: #555; }
        tr:last-child td { border-bottom: none; }
        tr:nth-child(even) { background-color: #fafbfc; }

        .net-positive { color: #2ecc71; font-weight: bold; }
        .net-negative { color: var(--danger-color); font-weight: bold; }

        /* Checkbox æ¨£å¼ (æ¼‚äº®ç‰ˆ) */
        .split-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
            padding: 10px;
            background: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        .split-checkbox-group label {
            display: inline-flex;
            align-items: center;
            background-color: #fff;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            user-select: none;
        }

        .split-checkbox-group label:hover {
            background-color: #f0f4ff;
            border-color: var(--primary-color);
        }

        .split-checkbox-group input { margin-right: 6px; }

        #selectAllLabel {
            background-color: #e8f5e9 !important;
            color: #2e7d32;
            border-color: #c8e6c9 !important;
            font-weight: bold;
        }

        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px dashed #eee;
        }
        .member-item:last-child { border-bottom: none; }

        .warning-text {
            color: #999;
            font-size: 0.85rem;
            text-align: center;
            margin-top: 10px;
        }
        
        #settlementSuggestions {
            background-color: #fffbe6;
            border: 1px solid #ffe58f;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        #settlementSuggestions p { margin: 5px 0; font-size: 1rem; }
        
        #memberCountBadge {
            background: #eee;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            color: #555;
            float: right;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¦¢ éµéµä¿±æ¨‚éƒ¨ åˆ†å¸³</h1>

    <div class="card">
        <h2>1. æˆå“¡è¨­å®š</h2>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="memberInput" placeholder="è¼¸å…¥æˆå“¡åç¨±..." style="flex: 1;">
        </div>
        <button id="addMemberBtn">ï¼‹ æ–°å¢æˆå“¡</button>
        
        <div style="margin-top: 20px;">
            <h3 style="font-size: 1rem; color: #777; margin-bottom: 10px;">
                ç•¶å‰æˆå“¡åˆ—è¡¨ <span id="memberCountBadge">0 äºº</span>
            </h3>
            <div id="memberList" style="border: 1px solid #eee; border-radius: 8px; padding: 5px;"></div>
        </div>
        <p class="warning-text">* æ³¨æ„ï¼šåˆªé™¤æˆ–ç·¨è¼¯æˆå“¡åç¨±å°‡æ¸…ç©ºæ‰€æœ‰æ”¯å‡ºç´€éŒ„ã€‚</p>
    </div>

    <div class="card">
        <h2>2. è¨˜éŒ„æ”¯å‡º</h2>
        <label style="font-weight:bold; display:block; margin-top:10px;">é …ç›®èªªæ˜</label>
        <input type="text" id="expenseName" placeholder="ä¾‹å¦‚: æ™šé¤ã€é£²æ–™...">
        
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label style="font-weight:bold; display:block; margin-top:10px;">é‡‘é¡ (è‡ªå‹•å–æ•´æ•¸)</label>
                <input type="number" id="expenseAmount" placeholder="$" min="0" step="1">
            </div>
            <div style="flex: 1; min-width: 200px;">
                <label style="font-weight:bold; display:block; margin-top:10px;">èª°å…ˆä»˜çš„ï¼Ÿ</label>
                <select id="paidBy"></select>
            </div>
        </div>

        <label style="font-weight:bold; display:block; margin-top:15px;">åˆ†çµ¦èª°ï¼Ÿ</label>
        <div id="splitMembersContainer" class="split-checkbox-group"></div>
        
        <button id="addExpenseBtn">ğŸ’¾ è¨˜éŒ„é€™ç­†æ”¯å‡º</button>
        <button id="cancelEditBtn" style="display:none;">å–æ¶ˆç·¨è¼¯</button>

        <h3 style="margin-top: 25px; border-bottom: 1px solid #eee; padding-bottom: 5px;">ğŸ“œ æ”¯å‡ºæ­·å²</h3>
        <div style="overflow-x: auto;">
            <table id="expenseTable">
                <thead>
                    <tr>
                        <th>èªªæ˜</th>
                        <th>é‡‘é¡</th>
                        <th>ä»˜æ¬¾äºº</th>
                        <th>åˆ†æ”¤äºº</th>
                        <th style="width: 130px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="expenseTbody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>3. çµç®—çµæœèˆ‡å»ºè­°</h2>
        
        <h3 style="font-size: 1.1rem;">ğŸ’° æˆå“¡æ·¨é¡ç‹€æ³</h3>
        <div style="overflow-x: auto;">
            <table id="netTable">
                <thead>
                    <tr>
                        <th>æˆå“¡</th>
                        <th>æ·¨é¡</th>
                        <th>ç‹€æ…‹</th>
                    </tr>
                </thead>
                <tbody id="netTbody"></tbody>
            </table>
        </div>

        <h3 style="font-size: 1.1rem; margin-top: 30px;">ğŸ’¡ æœ€ä½³è½‰å¸³å»ºè­°</h3>
        <div id="settlementSuggestions"></div>

        <button id="copyToLineBtn" style="margin-top: 20px;">
            ğŸ“‹ è¤‡è£½çµæœ (æ–‡å­—)
        </button>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒè³‡æ–™ ---
    let allMembers = ["è˜‹æœ", "å¤§å“¥", "å°æ¯›", "ç¿”å“¥", "çƒé¾œ", "è€€å“¥", "èŠ‹åœ“", "å¯§å¯§", "ç¬¨è›‹"]; 
    let allExpenses = []; 
    let editingIndex = null; 
    let currentSettlementText = []; // ç”¨æ–¼è¤‡è£½

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        // ç¶å®šéœæ…‹æŒ‰éˆ•
        document.getElementById('addMemberBtn').onclick = addMember;
        document.getElementById('addExpenseBtn').onclick = addExpense;
        document.getElementById('cancelEditBtn').onclick = resetForm;
        document.getElementById('copyToLineBtn').onclick = copyToLine;
        
        // ç¶å®šå…¨é¸/å–®é¸äº‹ä»¶ (ä½¿ç”¨ Event Delegation ä»¥æ”¯æ´å‹•æ…‹æ›´æ–°)
        document.getElementById('splitMembersContainer').onclick = function(e) {
            // å› ç‚ºç¾åŒ–ç‰ˆçš„ checkbox è¢« label åŒ…ä½ï¼Œæˆ‘å€‘ç›£è½ input çš„é»æ“Š
            if (e.target.tagName === 'INPUT') {
                if (e.target.id === 'selectAll') {
                    toggleAll(e.target.checked);
                } else if (e.target.name === 'splitMember') {
                    checkSelectAllStatus();
                }
            }
        };

        renderAll(); // é¦–æ¬¡æ¸²æŸ“
    };

    // --- æ¸²æŸ“ç¸½æ§ (Render All) ---
    // é€™æ˜¯æœ€é—œéµçš„å‡½å¼ï¼Œæ¯æ¬¡è³‡æ–™è®Šå‹•éƒ½å‘¼å«å®ƒï¼Œä¿è­‰ç•«é¢è·Ÿè³‡æ–™ 100% åŒæ­¥
    function renderAll() {
        renderMembers();
        renderPaidBySelect();
        renderCheckboxes(); // é€™è£¡æœƒæ ¹æ“šæœ€æ–°çš„ allMembers é‡æ–°ç•«å‹¾é¸å–®
        renderExpenses();
        calculate();
    }

    // 1. æ¸²æŸ“æˆå“¡åˆ—è¡¨
    function renderMembers() {
        const list = document.getElementById('memberList');
        const badge = document.getElementById('memberCountBadge');
        
        badge.innerText = `å…± ${allMembers.length} äºº`;
        
        if (allMembers.length === 0) {
            list.innerHTML = '<p style="text-align:center; color:#999;">æš«ç„¡æˆå“¡</p>';
            return;
        }

        list.innerHTML = allMembers.map((m, i) => `
            <div class="member-item">
                <span style="font-weight:500;">${m}</span>
                <div>
                    <button class="action-btn btn-edit" onclick="editMember(${i})">ä¿®</button>
                    <button class="action-btn btn-del" onclick="deleteMember(${i})">åˆª</button>
                </div>
            </div>
        `).join('');
    }

    // 2. æ¸²æŸ“åˆ†æ”¤å‹¾é¸å–® (åŒ…å«ç¾åŒ–æ¨£å¼)
    function renderCheckboxes() {
        const container = document.getElementById('splitMembersContainer');
        container.innerHTML = ''; // å¼·åˆ¶æ¸…ç©º

        if (allMembers.length === 0) {
            container.innerHTML = '<p style="color:orange; padding:5px;">è«‹å…ˆæ–°å¢æˆå“¡ï¼</p>';
            return;
        }

        let html = `
            <label id="selectAllLabel">
                <input type="checkbox" id="selectAll" checked> å…¨é¸
            </label>
        `;
        
        html += allMembers.map(m => `
            <label>
                <input type="checkbox" name="splitMember" value="${m}" checked> ${m}
            </label>
        `).join('');

        container.innerHTML = html;
    }

    // 3. æ¸²æŸ“ä»˜æ¬¾äººä¸‹æ‹‰
    function renderPaidBySelect() {
        const sel = document.getElementById('paidBy');
        sel.innerHTML = allMembers.map(m => `<option value="${m}">${m}</option>`).join('');
    }

    // 4. æ¸²æŸ“æ”¯å‡ºè¡¨
    function renderExpenses() {
        const tbody = document.getElementById('expenseTbody');
        if (allExpenses.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999; padding:20px;">ç›®å‰æ²’æœ‰æ”¯å‡ºç´€éŒ„ ğŸƒ</td></tr>';
            return;
        }
        tbody.innerHTML = allExpenses.map((e, i) => `
            <tr>
                <td>${e.name}</td>
                <td style="font-weight:bold;">$${e.amount}</td>
                <td>${e.payer}</td>
                <td style="font-size:0.85rem; color:#666;">${e.splitList.length}äººåˆ†: ${e.splitList.join(', ')}</td>
                <td>
                    <button class="action-btn btn-edit" onclick="editExpense(${i})">ä¿®</button>
                    <button class="action-btn btn-del" onclick="deleteExpense(${i})">åˆª</button>
                </td>
            </tr>
        `).join('');
    }

    // --- é‚è¼¯åŠŸèƒ½ ---

    function addMember() {
        const val = document.getElementById('memberInput').value.trim();
        if (!val) return alert('è«‹è¼¸å…¥åå­—');
        if (allMembers.includes(val)) return alert('åå­—é‡è¤‡äº†');
        
        allMembers.push(val);
        document.getElementById('memberInput').value = '';
        renderAll(); // æ›´æ–°ä»‹é¢ (åŒ…å«å‹¾é¸å–®)
    }

    function deleteMember(index) {
        const name = allMembers[index];
        if (!confirm(`ç¢ºå®šåˆªé™¤ "${name}" å—ï¼Ÿ\n(æ³¨æ„ï¼šé€™æœƒæ¸…ç©ºç›®å‰çš„æ‰€æœ‰æ”¯å‡ºç´€éŒ„)`)) return;
        
        allMembers.splice(index, 1);
        allExpenses = []; // æ¸…ç©ºæ”¯å‡ºä»¥ä¿è­‰æ­£ç¢º
        resetForm();
        renderAll(); // *** é—œéµï¼šé€™è£¡æœƒè§¸ç™¼ renderCheckboxesï¼Œç§»é™¤è©²æˆå“¡ ***
    }

    function editMember(index) {
        const oldName = allMembers[index];
        const newName = prompt('ä¿®æ”¹åå­—:', oldName);
        if (!newName || newName === oldName) return;
        if (allMembers.includes(newName)) return alert('åå­—é‡è¤‡');
        
        if (!confirm('ä¿®æ”¹åå­—æœƒæ¸…ç©ºæ”¯å‡ºç´€éŒ„ï¼Œç¢ºå®šå—ï¼Ÿ')) return;
        
        allMembers[index] = newName;
        allExpenses = [];
        renderAll();
    }

    function addExpense() {
        if (allMembers.length === 0) return alert('æ²’æˆå“¡');
        
        const name = document.getElementById('expenseName').value.trim();
        const amount = Math.floor(parseFloat(document.getElementById('expenseAmount').value));
        const payer = document.getElementById('paidBy').value;
        
        const checkedBoxes = document.querySelectorAll('input[name="splitMember"]:checked');
        const splitList = Array.from(checkedBoxes).map(cb => cb.value);

        if (!name || isNaN(amount) || amount <= 0 || !payer || splitList.length === 0) {
            return alert('è³‡æ–™ä¸å®Œæ•´ (é‡‘é¡éœ€>0ï¼Œä¸”è‡³å°‘å‹¾é¸ä¸€äºº)');
        }

        const record = { name, amount, payer, splitList };

        if (editingIndex !== null) {
            allExpenses[editingIndex] = record;
        } else {
            allExpenses.push(record);
        }

        resetForm();
        renderAll();
    }

    function deleteExpense(index) {
        if (!confirm('åˆªé™¤æ­¤ç­†æ”¯å‡ºï¼Ÿ')) return;
        allExpenses.splice(index, 1);
        renderAll();
    }

    function editExpense(index) {
        editingIndex = index;
        const exp = allExpenses[index];
        
        document.getElementById('expenseName').value = exp.name;
        document.getElementById('expenseAmount').value = exp.amount;
        document.getElementById('paidBy').value = exp.payer;
        
        // æ¢å¾©å‹¾é¸ç‹€æ…‹
        const boxes = document.querySelectorAll('input[name="splitMember"]');
        boxes.forEach(box => {
            box.checked = exp.splitList.includes(box.value);
        });
        checkSelectAllStatus();

        document.getElementById('addExpenseBtn').innerText = 'ğŸ’¾ å„²å­˜è®Šæ›´';
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
        document.getElementById('expenseName').focus();
    }

    function resetForm() {
        editingIndex = null;
        document.getElementById('expenseName').value = '';
        document.getElementById('expenseAmount').value = '';
        document.getElementById('addExpenseBtn').innerText = 'ğŸ’¾ è¨˜éŒ„é€™ç­†æ”¯å‡º';
        document.getElementById('cancelEditBtn').style.display = 'none';
        
        // é è¨­å…¨é¸
        toggleAll(true);
    }

    // Checkbox è¼”åŠ©
    function toggleAll(checked) {
        document.querySelectorAll('input[name="splitMember"]').forEach(cb => cb.checked = checked);
        const selectAll = document.getElementById('selectAll');
        if(selectAll) selectAll.checked = checked;
    }
    
    function checkSelectAllStatus() {
        const all = document.querySelectorAll('input[name="splitMember"]');
        const checked = document.querySelectorAll('input[name="splitMember"]:checked');
        const selectAll = document.getElementById('selectAll');
        if(selectAll) selectAll.checked = (all.length > 0 && all.length === checked.length);
    }

    // --- è¨ˆç®—æ ¸å¿ƒ (æ•´æ•¸) ---
    function calculate() {
        const net = {};
        allMembers.forEach(m => net[m] = 0);

        allExpenses.forEach(e => {
            const count = e.splitList.length;
            if (count === 0) return;
            
            net[e.payer] += e.amount;
            
            const base = Math.floor(e.amount / count);
            const remainder = e.amount % count;
            
            e.splitList.forEach((m, i) => {
                const share = base + (i < remainder ? 1 : 0);
                net[m] -= share;
            });
        });

        renderNetTable(net);
        renderSuggestions(net);
    }

    function renderNetTable(net) {
        const tbody = document.getElementById('netTbody');
        if (allMembers.length === 0) {
             tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">è«‹å…ˆæ–°å¢æˆå“¡</td></tr>';
             return;
        }
        tbody.innerHTML = allMembers.map(m => {
            const val = net[m];
            const color = val > 0 ? '#2ecc71' : (val < 0 ? '#ff6b6b' : '#333');
            const status = val > 0 ? 'æ‡‰æ”¶' : (val < 0 ? 'æ‡‰ä»˜' : 'çµæ¸…');
            return `
                <tr>
                    <td>${m}</td>
                    <td style="color:${color}; font-weight:bold;">$${Math.abs(val)}</td>
                    <td>${status}</td>
                </tr>
            `;
        }).join('');
    }

    function renderSuggestions(net) {
        const div = document.getElementById('settlementSuggestions');
        
        let balances = Object.entries(net).filter(x => x[1] !== 0).sort((a,b) => a[1] - b[1]);
        let html = '';
        let i = 0; 
        let j = balances.length - 1;
        
        currentSettlementText = []; // æ¸…ç©ºè¤‡è£½æ–‡å­—

        while (i < j) {
            const debtor = balances[i];
            const creditor = balances[j];
            const amount = Math.min(Math.abs(debtor[1]), creditor[1]);
            
            if (amount > 0) {
                html += `<p>ğŸ‘‰ <b>${debtor[0]}</b> çµ¦ <b>${creditor[0]}</b>: <span style="color:#e55050; font-weight:bold;">$${amount}</span></p>`;
                currentSettlementText.push(`${debtor[0]} çµ¦ ${creditor[0]}: $${amount}`);
            }

            balances[i][1] += amount;
            balances[j][1] -= amount;
            
            if (balances[i][1] === 0) i++;
            if (balances[j][1] === 0) j--;
        }

        if (!html) html = '<p style="text-align:center; color:#2ecc71; font-weight:bold;">ğŸ‰ å…¨æ•¸çµæ¸…ï¼</p>';
        div.innerHTML = html;
    }

    function copyToLine() {
        if (currentSettlementText.length === 0) {
            // æª¢æŸ¥æ˜¯å¦çœŸçš„çµæ¸…ï¼Œé‚„æ˜¯åªæ˜¯æ²’è³‡æ–™
            if (allExpenses.length > 0) return alert('ğŸ‰ å¤§å®¶éƒ½çµæ¸…å›‰ï¼ä¸ç”¨è½‰å¸³ã€‚');
            return alert('ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥è¤‡è£½å–”');
        }
        
        let text = "ğŸ¦¢ éµéµä¿±æ¨‚éƒ¨ - åˆ†å¸³çµæœ\n";
        text += "====================\n\n";
        text += currentSettlementText.join('\n');
        text += "\n\nğŸ’° è¨˜å¾—è½‰å¸³å–”ï¼\n";
        text += "====================\n";
        text += `å…± ${allExpenses.length} ç­†æ”¯å‡ºç´€éŒ„`;
        
        navigator.clipboard.writeText(text)
            .then(() => alert('âœ… å·²è¤‡è£½çµæœï¼è«‹åˆ° LINE è²¼ä¸Šã€‚'))
            .catch(() => alert('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚'));
    }
</script>

</body>
</html>
