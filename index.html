<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éµéµä¿±æ¨‚éƒ¨-åˆ†å¸³ç¶²é </title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f4f7f9;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        input, select {
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            font-size: 1rem;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
            transition: 0.2s;
        }

        #addMemberBtn, #addExpenseBtn { background-color: var(--primary-color); color: white; }
        #cancelEditBtn { background-color: #95a5a6; color: white; }
        
        #copyToLineBtn {
            background-color: #06c755;
            color: white;
            font-size: 1.1rem;
            margin-top: 20px;
        }
        #copyToLineBtn:hover { background-color: #05b34c; }

        /* åˆ—è¡¨æ¨£å¼ */
        .member-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px dashed #eee;
        }

        /* Checkbox */
        .split-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .split-checkbox-group label {
            display: inline-flex;
            align-items: center;
            background-color: #fff;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #e0e0e0;
            cursor: pointer;
        }
        .split-checkbox-group input { margin-right: 6px; }
        #selectAllLabel { background-color: #e8f5e9 !important; color: #2e7d32; font-weight: bold; }

        /* è¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; }

        /* å°æŒ‰éˆ• */
        .action-btn { padding: 4px 10px; margin-left: 5px; border-radius: 4px; width: auto; font-size: 0.85rem; }
        .btn-edit { background: #f1c40f; color: white; }
        .btn-del { background: #ff6b6b; color: white; }

        /* çµç®—çµæœå€å¡Šæ¨£å¼ */
        #reportArea {
            background-color: #fffbe6;
            border: 1px solid #ffe58f;
            padding: 20px;
            border-radius: 8px;
            font-family: monospace; /* ç­‰å¯¬å­—é«”æ–¹ä¾¿å°é½Š */
            white-space: pre-wrap; /* ä¿ç•™æ›è¡Œå’Œç©ºç™½ */
            color: #333;
            font-size: 0.95rem;
            line-height: 1.5;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¦¢ éµéµä¿±æ¨‚éƒ¨ åˆ†å¸³</h1>

    <div class="card">
        <h2>1. æˆå“¡è¨­å®š</h2>
        <input type="text" id="memberInput" placeholder="è¼¸å…¥æˆå“¡åç¨±...">
        <button id="addMemberBtn">ï¼‹ æ–°å¢æˆå“¡</button>
        <div style="margin-top:15px;">
            <h3>ç•¶å‰æˆå“¡åˆ—è¡¨ (<span id="memberCount">0</span>)</h3>
            <div id="memberList"></div>
        </div>
        <p style="color:#999; font-size:0.8rem; text-align:center; margin-top:10px;">* åˆªé™¤æˆå“¡æœƒæ¸…ç©ºæ‰€æœ‰æ”¯å‡ºç´€éŒ„</p>
    </div>

    <div class="card">
        <h2>2. è¨˜éŒ„æ”¯å‡º</h2>
        <input type="text" id="expenseName" placeholder="é …ç›® (ä¾‹å¦‚: æ™šé¤)">
        <input type="number" id="expenseAmount" placeholder="é‡‘é¡ (è‡ªå‹•å–æ•´æ•¸)" min="0" step="1">
        
        <label style="display:block; margin-top:10px; font-weight:bold;">èª°å…ˆä»˜çš„ï¼Ÿ</label>
        <select id="paidBy"></select>

        <label style="display:block; margin-top:15px; font-weight:bold;">åˆ†çµ¦èª°ï¼Ÿ</label>
        <div id="splitMembersContainer" class="split-checkbox-group"></div>
        
        <button id="addExpenseBtn">ğŸ’¾ è¨˜éŒ„æ”¯å‡º</button>
        <button id="cancelEditBtn" style="display:none;">å–æ¶ˆç·¨è¼¯</button>

        <h3>æ”¯å‡ºæ­·å²</h3>
        <div style="overflow-x:auto;">
            <table id="expenseTable">
                <thead><tr><th>é …ç›®</th><th>é‡‘é¡</th><th>ä»˜</th><th>åˆ†</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="expenseTbody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2>3. çµç®—èˆ‡å»ºè­°</h2>
        
        <div id="reportArea"></div>

        <button id="copyToLineBtn">ğŸ“‹ è¤‡è£½çµæœ (å‚³åˆ°LINE)</button>
    </div>
</div>

<script>
    // --- è³‡æ–™ ---
    let allMembers = ["è˜‹æœ", "å¤§å“¥", "å°æ¯›", "ç¿”å“¥", "çƒé¾œ", "è€€å“¥", "èŠ‹åœ“", "å¯§å¯§", "ç¬¨è›‹"]; 
    let allExpenses = []; 
    let editingIndex = null; 
    let finalReportText = ""; // å„²å­˜æœ€å¾Œè¦è¤‡è£½çš„æ–‡å­—

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        document.getElementById('addMemberBtn').onclick = addMember;
        document.getElementById('addExpenseBtn').onclick = addExpense;
        document.getElementById('cancelEditBtn').onclick = resetForm;
        document.getElementById('copyToLineBtn').onclick = copyToLine;
        
        // Checkbox äº‹ä»¶å§”æ´¾
        document.getElementById('splitMembersContainer').onclick = function(e) {
            if (e.target.tagName === 'INPUT') {
                if (e.target.id === 'selectAll') toggleAll(e.target.checked);
                else if (e.target.name === 'splitMember') checkSelectAllStatus();
            }
        };

        renderAll();
    };

    function renderAll() {
        renderMembers();
        renderPaidBySelect();
        renderCheckboxes();
        renderExpenses();
        calculateAndGenerateReport();
    }

    // --- 1. æˆå“¡æ¸²æŸ“ ---
    function renderMembers() {
        const list = document.getElementById('memberList');
        document.getElementById('memberCount').innerText = allMembers.length;
        
        if (allMembers.length === 0) {
            list.innerHTML = '<p style="text-align:center; color:#999;">ç„¡æˆå“¡</p>';
            return;
        }

        list.innerHTML = allMembers.map((m, i) => `
            <div class="member-item">
                <span>${m}</span>
                <div>
                    <button class="action-btn btn-edit" onclick="editMember(${i})">ä¿®</button>
                    <button class="action-btn btn-del" onclick="deleteMember(${i})">åˆª</button>
                </div>
            </div>
        `).join('');
    }

    // --- 2. å‹¾é¸å–®æ¸²æŸ“ (å¼·åˆ¶é‡ç¹ª) ---
    function renderCheckboxes() {
        const container = document.getElementById('splitMembersContainer');
        container.innerHTML = ''; // æ¸…ç©º

        if (allMembers.length === 0) {
            container.innerHTML = '<span style="color:orange;">è«‹å…ˆæ–°å¢æˆå“¡</span>';
            return;
        }

        let html = `
            <label id="selectAllLabel">
                <input type="checkbox" id="selectAll" checked> å…¨é¸
            </label>
        `;
        html += allMembers.map(m => `
            <label><input type="checkbox" name="splitMember" value="${m}" checked> ${m}</label>
        `).join('');
        container.innerHTML = html;
    }

    // --- 3. ä¸‹æ‹‰é¸å–® ---
    function renderPaidBySelect() {
        document.getElementById('paidBy').innerHTML = allMembers.map(m => `<option value="${m}">${m}</option>`).join('');
    }

    // --- 4. æ”¯å‡ºåˆ—è¡¨ ---
    function renderExpenses() {
        const tbody = document.getElementById('expenseTbody');
        if (allExpenses.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">ç„¡ç´€éŒ„</td></tr>';
            return;
        }
        tbody.innerHTML = allExpenses.map((e, i) => `
            <tr>
                <td>${e.name}</td><td>$${e.amount}</td><td>${e.payer}</td>
                <td style="font-size:0.8rem; color:#666;">${e.splitList.length}äººåˆ†</td>
                <td>
                    <button class="action-btn btn-edit" onclick="editExpense(${i})">ä¿®</button>
                    <button class="action-btn btn-del" onclick="deleteExpense(${i})">åˆª</button>
                </td>
            </tr>
        `).join('');
    }

    // --- åŠŸèƒ½é‚è¼¯ ---
    function addMember() {
        const val = document.getElementById('memberInput').value.trim();
        if (!val || allMembers.includes(val)) return alert('è«‹è¼¸å…¥æœ‰æ•ˆä¸”ä¸é‡è¤‡çš„åå­—');
        allMembers.push(val);
        document.getElementById('memberInput').value = '';
        renderAll();
    }

    function deleteMember(index) {
        if (!confirm(`ç¢ºå®šåˆªé™¤ "${allMembers[index]}"ï¼Ÿ(å°‡æ¸…ç©ºæ”¯å‡º)`)) return;
        allMembers.splice(index, 1);
        allExpenses = [];
        resetForm();
        renderAll();
    }

    function editMember(index) {
        const newName = prompt('ä¿®æ”¹åå­—:', allMembers[index]);
        if (newName && newName !== allMembers[index] && !allMembers.includes(newName)) {
            if(confirm('ä¿®æ”¹åå­—æœƒæ¸…ç©ºæ”¯å‡ºï¼Œç¢ºå®šï¼Ÿ')) {
                allMembers[index] = newName.trim();
                allExpenses = [];
                renderAll();
            }
        }
    }

    function addExpense() {
        if (allMembers.length === 0) return alert('ç„¡æˆå“¡');
        const name = document.getElementById('expenseName').value.trim();
        const amount = Math.floor(parseFloat(document.getElementById('expenseAmount').value));
        const payer = document.getElementById('paidBy').value;
        const checked = document.querySelectorAll('input[name="splitMember"]:checked');
        const splitList = Array.from(checked).map(c => c.value);

        if (!name || isNaN(amount) || amount <= 0 || splitList.length === 0) return alert('è³‡æ–™ä¸å®Œæ•´');

        const record = { name, amount, payer, splitList };
        if (editingIndex !== null) allExpenses[editingIndex] = record;
        else allExpenses.push(record);

        resetForm();
        renderAll();
    }

    function deleteExpense(i) {
        if (confirm('åˆªé™¤æ­¤ç­†ï¼Ÿ')) {
            allExpenses.splice(i, 1);
            renderAll();
        }
    }

    function editExpense(i) {
        editingIndex = i;
        const e = allExpenses[i];
        document.getElementById('expenseName').value = e.name;
        document.getElementById('expenseAmount').value = e.amount;
        document.getElementById('paidBy').value = e.payer;
        
        const boxes = document.querySelectorAll('input[name="splitMember"]');
        boxes.forEach(b => b.checked = e.splitList.includes(b.value));
        checkSelectAllStatus();

        document.getElementById('addExpenseBtn').innerText = 'å„²å­˜ä¿®æ”¹';
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
    }

    function resetForm() {
        editingIndex = null;
        document.getElementById('expenseName').value = '';
        document.getElementById('expenseAmount').value = '';
        document.getElementById('addExpenseBtn').innerText = 'ğŸ’¾ è¨˜éŒ„æ”¯å‡º';
        document.getElementById('cancelEditBtn').style.display = 'none';
        toggleAll(true);
    }

    function toggleAll(checked) {
        document.querySelectorAll('input[name="splitMember"]').forEach(c => c.checked = checked);
        const all = document.getElementById('selectAll'); if(all) all.checked = checked;
    }
    function checkSelectAllStatus() {
        const all = document.querySelectorAll('input[name="splitMember"]');
        const checked = document.querySelectorAll('input[name="splitMember"]:checked');
        const allBox = document.getElementById('selectAll');
        if(allBox) allBox.checked = (all.length > 0 && all.length === checked.length);
    }

    // --- 5. æ ¸å¿ƒè¨ˆç®—èˆ‡å ±å‘Šç”Ÿæˆ (é—œéµä¿®æ”¹) ---
    function calculateAndGenerateReport() {
        const reportDiv = document.getElementById('reportArea');
        
        // 1. è¨ˆç®—æ·¨é¡
        const net = {};
        allMembers.forEach(m => net[m] = 0);
        allExpenses.forEach(e => {
            const count = e.splitList.length;
            if (count === 0) return;
            net[e.payer] += e.amount;
            const base = Math.floor(e.amount / count);
            const rem = e.amount % count;
            e.splitList.forEach((m, i) => net[m] -= (base + (i < rem ? 1 : 0)));
        });

        // 2. ç”¢ç”Ÿæ‡‰æ”¶æ¬¾åˆ—è¡¨ (å¤§æ–¼0çš„äºº)
        const receivables = Object.entries(net)
            .filter(x => x[1] > 0)
            .sort((a, b) => b[1] - a[1]); // é‡‘é¡å¾å¤§åˆ°å°æ’

        // 3. è¨ˆç®—è½‰å¸³ (Greedy Algorithm)
        let balances = Object.entries(net).filter(x => x[1] !== 0).sort((a,b) => a[1] - b[1]);
        let settlements = [];
        let i = 0; 
        let j = balances.length - 1;
        
        while (i < j) {
            const debtor = balances[i];   // è² å‚µè€…
            const creditor = balances[j]; // å‚µæ¬Šè€…
            const amount = Math.min(Math.abs(debtor[1]), creditor[1]);
            
            if (amount > 0) {
                settlements.push({ from: debtor[0], to: creditor[0], amount: amount });
            }

            balances[i][1] += amount;
            balances[j][1] -= amount;
            
            if (balances[i][1] === 0) i++;
            if (balances[j][1] === 0) j--;
        }

        // 4. ä¾ç…§ã€Œæ”¶æ¬¾äºº (to)ã€åˆ†çµ„
        const groupedSettlements = {};
        settlements.forEach(s => {
            if (!groupedSettlements[s.to]) groupedSettlements[s.to] = [];
            groupedSettlements[s.to].push(s);
        });

        // 5. ç”¢ç”Ÿæœ€çµ‚æ–‡å­—
        let text = "ğŸ¦¢ éµéµä¿±æ¨‚éƒ¨ - åˆ†å¸³çµæœ\n";
        text += "====================\n";
        
        // é¡¯ç¤ºæ‡‰æ”¶æ¬¾å€å¡Š
        if (receivables.length > 0) {
            text += "                 æ‡‰æ”¶æ¬¾\n";
            receivables.forEach(item => {
                // ç°¡å–®çš„å°é½Šè™•ç† (å…¨å½¢ç©ºç™½ + åŠå½¢ç©ºç™½å¾®èª¿)
                const name = item[0];
                const amt = item[1];
                // åå­—è£œç©ºç™½é‚è¼¯ (å‡è¨­åå­—ä¸è¶…é4å€‹å­—)
                let space = "             "; 
                if (name.length === 2) space = "             ";
                if (name.length === 3) space = "           ";
                
                text += `${name}${space}${amt}\n`;
            });
            text += "\n";
        } else {
            text += "       ç›®å‰ç„¡æ¬ æ¬¾\n\n";
        }

        // é¡¯ç¤ºè½‰å¸³å»ºè­° (ä¾ç…§æ”¶æ¬¾äººåˆ†çµ„)
        const receivers = Object.keys(groupedSettlements);
        if (receivers.length > 0) {
            receivers.forEach((receiver, idx) => {
                const group = groupedSettlements[receiver];
                group.forEach(t => {
                    text += `${t.from} çµ¦ ${t.to}: $${t.amount}\n`;
                });
                // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€çµ„ï¼ŒåŠ åˆ†éš”ç·š
                if (idx < receivers.length - 1) {
                    text += "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n";
                }
            });
        } else {
            if (allExpenses.length > 0) text += "ğŸ‰ å¤§å®¶éƒ½çµæ¸…å›‰ï¼\n";
        }

        text += "\nğŸ’° è¨˜å¾—è½‰å¸³å–”ï¼\n";
        text += "====================\n";
        text += `å…± ${allExpenses.length} ç­†æ”¯å‡ºç´€éŒ„`;

        // 6. æ›´æ–°ç•«é¢ & å„²å­˜å…¨åŸŸè®Šæ•¸
        finalReportText = text;
        reportDiv.innerText = text;
    }

    function copyToLine() {
        if (!finalReportText) return alert('ç„¡å…§å®¹å¯è¤‡è£½');
        navigator.clipboard.writeText(finalReportText)
            .then(() => alert('âœ… å·²è¤‡è£½çµæœï¼\nè«‹ç›´æ¥åˆ° LINE è²¼ä¸Šã€‚'))
            .catch(() => alert('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ç•«é¢æ–‡å­—ã€‚'));
    }
</script>

</body>
</html>
